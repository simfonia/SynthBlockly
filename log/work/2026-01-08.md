# 2026-01-08 工作日誌

## 主要異動

### 1. 步進音序器 2.0 (Step Sequencer)
- **效能優化**：引入「預解析 (Pre-parsing)」技術。在產生積木代碼時 (Generator) 即將序列字串轉為陣列，大幅減輕執行期 (Runtime) 的運算壓力。
- **時序修正**：在 `playRhythmSequence` 加入 0.05s 的安全預視緩衝 (Look-ahead)，徹底解決了 Tone.js 的時序報警問題，同時維持了即時的演奏反應。
- **功能擴充**：
    - 支援 16 步進標準格式（十六分音符）。
    - 支援視覺分隔符 `|` 與空白，提升序列字串易讀性。
    - 支援「多軌並行」：可指定 `Piano`, `Bass` 等樂器名稱直接發聲，不影響全域選定音源。
    - 支援「小節序號 (Measure)」：可跨小節精確編曲，並將「每隔 N 循環」擴充至最高 8 小節。
    - 支援「音符字串」：可直接在序列中寫入 `C4`, `G3` 等音符實現琶音。
- **UX 優化**：將來源選擇改為「下拉選單 + 自訂欄位」組合，並透過 Mutation 實作動態 UI 切換。

### 2. 音訊引擎穩定性與韌性
- **徹底解決停止延遲**：重寫 `resetAudioEngineState`，每次重設時會徹底銷毀 (`dispose`) 舊的樂器實例並重新建立。這保證了單音合成器（如小鼓）的尾音能被瞬間切斷。
- **修復資源載入 Bug**：在所有取樣播放函式中加入了 `.loaded` 保護檢查，未載入時會靜默跳過，解決了 `buffer not loaded` 的報錯。
- **非同步排程優化**：移除發聲函式中的 `async/await`，確保所有音訊排程在同一個執行堆疊中完成，保證節奏絕對對齊。

### 3. 全域系統統整
- **移調系統一致化**：新增 `getTransposedNote()` 輔助函式，統一處理字串與數字 (MIDI) 的移調。PC 鍵盤與 MIDI 鍵盤現在共享同一個全域位移變數。
- **PC 鍵盤性能提升**：改用 `Attack` / `Release` 模式，支援長按持續音 (Sustain)。
- **工具箱分類調整**：新增「工具 (Tools)」類別並實作「註解」積木；將和弦播放積木移入「演奏 (Performance)」類別。

### 4. 文件與範例更新
- **新增手冊**：建立 `step_sequencer_readme_*.html` 與 `transport_readme_*.html` 並連結至積木右鍵選單。
- **範例維護**：對調了範例 10 與 11 的編號，並修正了範例 12 的 XML 以相容新版積木結構。

## 目前狀態
- **穩定性**：極佳。已消除所有已知語法錯誤、JavaScript 報錯與 Tone.js 時序警告。
- **效能**：顯著提升。支援複雜的多聲部並行編曲。
