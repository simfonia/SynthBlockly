# 2026-01-09 工作日誌 (SynthBlockly)

## 主要異動

### 1. 時序與播放穩定性優化
- **安全預視機制**：在 `audioEngine.js` 的所有發聲函式（`playKick`, `playRhythmSequence`, `_playSpecificInstrumentNote` 等）中統一加入 **0.05s 的 Look-ahead 緩衝**。
- **時序報警修復**：解決了範例 12 中「Events scheduled inside of scheduled callbacks should use the passed in scheduling time」的警告。
- **消除延遲感**：移除 `Transport.start` 原有的 0.1s 延遲，配合內建緩衝，使預備拍後的第一拍觸發更精準、無空隙。
- **邏輯重整**：修正範例 02，確保先建立 Loop 再啟動 Transport，解決首拍延遲問題。

### 2. ADSR 包絡系統徹底翻新
- **線性曲線切換**：將包絡線預設的指數 (Exponential) 曲線改為 **線性 (Linear) 曲線**。解決了 Decay/Release 設定大數值時，聽感上卻在頭 2 秒就結束的問題。
- **智慧 UI 同步**：修改 `blocklyManager.js`，現在工作區發生載入、建立、變動或刪除積木時，ADSR 視覺化視窗會自動尋找積木並同步數值；若積木被刪除，則自動回復預設值。
- **數值範圍擴張**：將 A, D, R 的上限由 10 秒提升至 **60 秒**，支援極長環境音色設計。
- **0 值修復**：修正產生器與 UI 邏輯中將 `0` 判定為假值而跳回預設值的錯誤。

### 3. 進階合成器功能復原與強化 (範例 5)
- **加法合成實作**：重新實作 `createAdditiveInstrument`，採用自訂 `AdditiveVoice` 繼承 `Tone.Synth` 的架構，支援非整數頻率倍率。
- **振幅正規化**：新增自動計算總振幅邏輯，若總和超過 1.0 則自動等比縮放，防止波形爆表過載。
- **釋放邏輯修正**：在 Release 時加入 `envelope.cancel()`，修復長 Decay 期間釋放按鍵會產生微弱持續音的 Bug。
- **諧波合成實作**：完善 `createCustomWaveInstrument`，支援自訂 Partials 陣列。

### 4. 演奏控制與日誌系統
- **Note ID 防護機制**：為 PC 鍵盤與 MIDI 事件導入 Note ID 追蹤。確保 Note Off 訊號只會影響與其對應的 Note On 動畫，徹底解決快速連彈時 ADSR 光點顯示錯亂的問題。
- **日誌美化**：將「切換樂器成功」與「ADSR 套用」等關鍵訊息改為紅色粗體 (`important` 類型) 並顯示在主訊息區。
- **MIDI LOG 修復**：修正 MIDI Note On LOG 格式，加入裝置名稱顯示並修復佔位符錯位。

### 5. UI 佈局微調
- 調整工具列按鈕順序：`[新專案|範例|儲存|載入] [序列埠|MIDI] [執行|停止|測試音|匯出] [清除日誌]`。

## 異動檔案
- `SynthBlockly/index.html`
- `SynthBlockly/js/core/audioEngine.js`
- `SynthBlockly/js/core/blocklyManager.js`
- `SynthBlockly/js/core/midiEngine.js`
- `SynthBlockly/js/blocks/instruments_blocks.js`
- `SynthBlockly/js/blocks/instruments_generators.js`
- `SynthBlockly/js/blocks/transport_generators.js`
- `SynthBlockly/js/ui/keyboardController.js`
- `SynthBlockly/js/ui/adsrVisualizer.js`
- `SynthBlockly/js/blocks/lang/zh-hant.js`
- `SynthBlockly/js/blocks/lang/en.js`
