# 2026-01-03 工作日誌

## 主要異動

### 1. 全域移調系統 (Global Transposition)
- **核心優化**：在 `audioEngine.js` 中實作 `getTransposedNote()`，統一處理字串 (Tone.Frequency) 與數字 (Tone.Midi) 的移調。
- **一致性控制**：
    - **PC 鍵盤**：移除了個別樂器的 `detune` 設定，改為修改全域 `currentSemitoneOffset`。
    - **MIDI 鍵盤**：彈奏單音與和弦現在都會自動套用全域移調。
    - **快捷鍵**：上下鍵改為 +/- 12 半音，與 +/- 鍵連動。
- **修復**：解決了 MIDI 鍵號被錯誤識別為頻率 (Hz) 的問題。

### 2. 範例系統與 TTP229 整合
- **功能擴充**：
    - **10_Chord_Pad**：展示順階和弦映射。
    - **11_Drum_Pad**：展示 Bitmask 多鍵同時觸發模式。
- **通訊協議**：
    - 新增 `sb_serial_check_key_mask` 積木，支援解析 `KEYS:N` 格式的 Bitmask 資料。
    - 新增 `sb_play_chord_by_name` 通用演奏積木。
- **文件**：更新 README 說明，加入 TP3 接地以啟用多鍵模式的指引。

### 3. UI 與引擎穩定性修復
- **Resizer 修復**：透過 `min-width: 0` 修正了調整分割畫面寬度時右側面板溢出的 CSS 問題。
- **Panic Stop 優化**：重寫 `resetAudioEngineState`，確保所有 `Tone.Loop` (blocklyLoops) 被主動停止並銷毀，解決停止延遲問題。
- **發聲修復**：修正了「播放測試音」按鈕在切換樂器後無聲的問題。

### 4. 工具類別與註解功能
- **新分類**：在工具箱新增「工具 (Tools)」類別，顏色為深灰色 (`#777777`)。
- **註解積木**：實作 `sb_comment` 積木，支援多行文字輸入且不產生任何執行代碼，方便使用者在工作區標記邏輯。

## 技術備註
- `audioEngine.js` 已進行代碼清理，移除了重複的函式定義並修正了 `replace` 造成的語法錯誤。
- PC 鍵盤現在支援長按持續音 (Sustain)，透過 `Attack` / `Release` 函式對應 `keydown` / `keyup` 事件。