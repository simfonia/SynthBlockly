# 2026-01-02 工作日誌 (SynthBlockly)

## 重大異動與修復

### 1. 序列埠 (Serial) 通訊架構優化
- **功能修復**：修正 `sb_serial_data_received` 積木。透過手動註冊標準產生器 (Logic, Text, Variables) 解決無法產生判斷式代碼的問題。
- **連線切換**：連線按鈕改為 Toggle 模式。新增 `disconnectSerial` 函式，正確處理 `reader.cancel()` 與 `reader.releaseLock()`，解決中斷連線時的 `TypeError`。
- **UI 回饋**：連線成功時按鈕變為指定綠色 (`#75FB4C`) 並套用 `.active` 類別，斷開後恢復原狀。

### 2. MIDI 自動化與視覺統一
- **自動連線**：將 MIDI 存取請求整合至 `startAudioOnFirstInteraction`。使用者首次點擊畫面啟動音訊時，系統會同步嘗試連線 MIDI。
- **視覺規範**：修正 MIDI 按鈕樣式，確保其顏色、類別行為與序列埠按鈕一致。

### 3. 智慧型日誌清理系統 (Targeted Log Clearing)
- **分類機制**：在 `logger.js` 中新增 `data-category` 標記，利用語系鍵值前綴 (如 `LOG_SERIAL_`) 自動將日誌歸類。
- **定向清除**：修改各引擎模組，在重新嘗試連線或執行前僅呼叫 `clearErrorLog('CATEGORY')`。
- **優點**：解決了「修復 A 錯誤時意外刪掉尚未排除的 B 警告」之 UX 問題，並確保系統級崩潰訊息被保留。

### 4. 語言包與 Tooltip 優化
- 補齊 `LOG_SERIAL_PORT_BUSY`, `LOG_SERIAL_DISCONNECTED`, `LOG_MIDI_CONNECTED_TOOLTIP` 等中英文字串。
- 修正電子鼓積木的 `VELOCITY` 產生器預設值，防止空值導致執行錯誤。

## 技術規範更新
- **監聽器註冊**：序列埠與 MIDI 監聽器現在統一透過 `window.__synthBlocklySerialListeners` 共享，解決 `serialEngine.js` 與 `blocklyManager.js` 定義衝突問題。
- **非同步執行**：事件積木內部的程式碼採用 `new Function` 預編譯並包裹在 `async IIFE` 中執行，提升高頻觸發下的效能。
