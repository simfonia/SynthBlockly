# 工作日誌 2026-01-24

## 今日進度
1. **V2.0 架構重構：定義與執行分離**
   - 修改 `blocklyManager.js` 中的 `getBlocksCode`。
   - 掃描所有頂層積木，將建立音源、設定 ADSR、定義和弦等「配置類」積木優先於「演奏類」積木執行。
   - 解決了積木擺放順序可能導致的初始化報錯問題。
2. **分軌路由 (Multi-track Routing) 進階化**
   - 在 `audioEngine.js` 中為每個樂器引入 `Tone.Channel` 節點。
   - 訊號流：`樂器 -> 局部效果器 -> 頻道 (Volume/Mute/Solo) -> 全域效果器 -> 輸出`。
3. **新增音量/靜音/獨奏控制積木**
   - 新增 `sb_set_instrument_mute` 與 `sb_set_instrument_solo` 積木。
   - 更新 `sb_set_instrument_volume` 產生器，改為操作 Channel 節點。
   - 補齊中英文翻譯字串。
4. **系統穩定性優化**
   - 更新 `resetAudioEngineState`，確保所有 Channel 節點在重置時被釋放，防止記憶體洩漏。
   - 將所有更動前的關鍵檔案備份至 `backup/` 目錄。

## 技術細節
- **Channel 路由的好處**：原本音量控制是直接在樂器上，如果樂器有局部效果器，音量控制會顯得混亂。現在有了 Channel，音量控制位於效果器之後，更符合真實混音台的邏輯，且內建的 Solo/Mute 功能非常穩定。
- **配置分離邏輯**：透過過濾頂層積木類型，我們能確保在 `AsyncFunction` 執行時，環境已經準備好。這對於教學範例中隨意擺放積木的習慣非常有幫助。

## 下一步建議
1. 實作 `sb_clear_effects` 積木，允許清除特定音源或全域的效果器鏈。
2. 擴充 `sb_play_melody` 對和弦名稱的支持。

## 2026-01-24 任務總結 (Append)
1. **核心架構升級 (V2.0)**
   - 實作了「優先權產生碼」邏輯：樂器建立 > 系統設定/音序排程 > 主程式執行。這解決了 XML 載入順序與執行時機的相依性問題。
   - 優化了 `getBlocksCode`，透過暫時斷開連線的方式防止產生器遞迴導致的代碼重複。
2. **混音台系統 (Channel Routing)**
   - 每個樂器現在都擁有專屬的 `Tone.Channel`。
   - 支援了獨立的音量 (Volume)、靜音 (Mute) 與獨奏 (Solo) 功能。
   - 修正了音量為 0 時 Mute/Unmute 的 Tone.js 恢復機制 Bug。
3. **UI 穩定性與模組化**
   - 實作 ``FieldDropdownLenient`` 類別，透過覆寫 ``getOptions`` 解決了 XML 前向參考導致下拉選單顯示錯誤的問題。
   - 將 ``sb_select_current_instrument`` 移至「演奏」分類並搬移至 ``melody_blocks.js / generators.js`` 模組。
   - 成功將 ``sb_rhythm_source_selector`` 的自訂欄位改回自動下拉選單模式（經由 ``FieldDropdownLenient`` 優化），兼顧了 UI 易用性與載入穩定性。
4. **範例更新**
   - 建立並優化範例 `15_Mixer_Demo.xml`，完整示範分軌混音與 V2.0 架構優勢。
