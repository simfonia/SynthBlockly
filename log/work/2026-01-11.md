# 2026-01-11 工作日誌 (SynthBlockly)

## 主要異動

### 1. 時序系統錯誤修復 (Critical Fix)
- **解決 TDZ 報錯**：修復了 `sb_schedule_at_offset` 積木產生的 JavaScript 程式碼中，因 `const scheduledTime` 宣告導致的「暫時性死區 (Temporal Dead Zone)」錯誤。
- **重構產生器邏輯**：將偏移時間的計算 (`_calcOffset`, `_baseTime`) 移至區塊範圍外，確保在正式宣告 `const scheduledTime` 之前，能安全地獲取上層環境的時間戳記。
- **統一變數命名**：全面將內部使用的 `time` 更名為 **`scheduledTime`**。同步更新了 `sb_tone_loop`、`sb_rhythm_sequence` 以及所有發聲積木（`sb_play_note` 等），確保在 Loop 或 Offset 嵌套環境下，時間傳遞精確無誤。

### 2. 插件相容性優化 (GitHub Pages Deployment)
- **重構多行輸入插件**：將 `js/plugins/field-multilineinput.js` 由原本的 UMD/CommonJS 格式重構為純淨的 **ES Module (ESM)**。
- **移除 Node.js 依賴**：刪除所有對 `require`、`module.exports` 與 `exports` 的引用與判斷，改為直接存取全域 `window.Blockly`。
- **解決部署報錯**：此更動徹底解決了專案部署至 GitHub Pages 後，因瀏覽器不支援 `require` 而產生的 `ReferenceError: require is not defined` 錯誤。

### 3. 穩定性微調
- 更新 `sb_play_note_and_wait` 與 `sb_play_drum` 等發聲積木，強化對 `scheduledTime` 的偵測邏輯，確保在非排程環境下（如直接點擊積木）也能正確回退至 `Tone.now()`。

## 異動檔案
- `SynthBlockly/js/blocks/transport_generators.js`
- `SynthBlockly/js/blocks/instruments_generators.js`
- `SynthBlockly/js/plugins/field-multilineinput.js`
