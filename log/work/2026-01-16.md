# 工作日誌 2026-01-16

## 今日重點異動
1.  **步進音序器 (Step Sequencer) 大幅升級**
    *   **支援和弦播放**：新增「使用和弦名稱?」勾選框。勾選後，序列中的 `C7`、`Fmaj7` 等代號將被解析為已定義的和弦內容進行播放。
    *   **動態來源選擇**：將原本的 `TYPE` 欄位改為輸入接口，並預設帶有 `sb_rhythm_source_selector` 影子積木。自訂樂器名稱現在支援動態下拉選單（自動掃描工作區已建立的樂器）。
    *   **動態小節數**：小節數參數改為 Value Input，支援使用變數（如 `i`）或數學積木，方便在迴圈中編排。
    *   **引擎層鎖定樂器**：在 `audioEngine.playRhythmSequence` 中加入樂器閉包鎖定邏輯，確保背景音序器不會因全域 `currentInstrumentName` 的切換而被主奏音色蓋過。

2.  **和弦系統功能增強**
    *   **定義和弦積木**：還原為 Statement 類型（語句積木），維持獨立定義的直覺性。
    *   **新增和弦名稱積木 (`sb_get_chord_name`)**：具備自動掃描工作區功能，提供下拉選單供使用者選擇已定義的和弦名稱，用於嵌入音序器。

3.  **ADSR 包絡線優化**
    *   **目標選擇功能**：`sb_set_adsr` 積木新增「目標」下拉選單，預設為「全部音源」，亦可選擇特定自訂音色進行精細設定。

4.  **系統架構與安全機制**
    *   **Master Limiter**：在音訊輸出鏈最後端加入 `-1dB` 的全域 Limiter，防止多軌疊加時產生數位破音。
    *   **XML 存檔美化**：匯出專案 XML 時使用 `domToPrettyText`，使其具備正確縮排與換行，便於閱讀與管理。

5.  **說明文件更新**
    *   同步更新 `public/docs` 下的 `step_sequencer`、`performance`、`instrument` 中英文說明文件，涵蓋新增的和弦模式與 ADSR 目標設定等功能。

## 待解決問題 (已知 Bug)
*   **影子積木變形問題**：在包含音序器的迴圈積木執行複製貼上時，音序器內的影子積木（來源/小節）有時會變形消失。
*   **刪除積木跳動問題**：刪除積木後，工作區會自動選取第一個積木並捲動到最上方。目前已嘗試多種 CSS 與 JS 攔截方案，效果仍有限，懷疑與特定版本的 Blockly 核心行為有關。

## 檔案結構異動
*   `js/blocks/transport_blocks.js`：更新音序器定義與影子積木邏輯。
*   `js/blocks/instruments_blocks.js`：更新 ADSR、定義和弦積木，新增和弦名稱積木。
*   `js/blocks/transport_generators.js` & `instruments_generators.js`：同步更新對應的產生器。
*   `js/core/audioEngine.js`：加入 Master Limiter、升級 `playRhythmSequence` 邏輯。
*   `js/core/toolbox.js`：更新工具箱 XML 配置。
*   `js/ui/buttons.js`：更新 XML 存檔格式化邏輯。
*   `public/docs/*.html`：更新中英文指南。
*   `src/examples/13_12-bar blues.xml`：升級為多軌多和弦範例。
