# 2026-01-18 工作日誌

## 今日重要更新
1. **音序器解析引擎重構**：
   - 修正了無法解析長度大於 2 個字元（如 `Dm7`, `CM7`）或含底線（如 `Cmin_aug`）的和弦符號 bug。
   - 優化解析邏輯，使其能無視序列中的「空白」與「|」視覺分隔符，並在長度不符 16 格時發出警告。
2. **音源控制體系補全**：
   - 「設定音量」與「設定顫音」積木現在具備與 ADSR 積木一致的動態目標選單。
   - 選單中納入系統內建的 `KICK`, `SNARE`, `HH`, `JazzKit`，支援單獨控制節奏組音量。
3. **自訂取樣器擴充**：
   - `建立取樣音源` 積木現在支援單獨建立 JazzKit 的所有組件（如 Open HH, Handclap, Toms, Crash 等）。
   - 解決了 JazzKit 無法單獨控制各個鼓聲元件音量的問題。
4. **教材範例優化**：
   - 重新編寫 `08_Step Sequencer.xml`，實作流暢的小野麗莎 Bossa Nova 風格。
   - 補齊中英文說明文件中有關和弦符號規範、視覺分隔符的使用指南。
5. **UI/UX 改進**：
   - 「當收到 MIDI/序列埠」積木正式改為底部平整的「帽子積木」樣式。
   - 實作「點擊選取 ADSR 積木即同步更新視覺化圖形」的功能。

## 關鍵技術細節 (踩過的坑)
- **時序警告 (Scheduling Time Warning)**：
  - **現象**：控制台出現 `Events scheduled inside of scheduled callbacks should use the passed in scheduling time.`。
  - **成因**：在 `Tone.Loop` 或 `Tone.Transport` 的回呼中，使用了 `Tone.now()` 或不精確的時間衍生值來觸發聲音。
  - **解法**：
    1. 確保所有底層發聲函式（`playKick`, `playJazzKitNote` 等）必須優先接受外部傳入的 `time` 參數。
    2. 檢查 `time !== undefined` 而非 `!time` (因為 0 也是有效時間)。
    3. 在計算 `t = mStart + offset` 時，`mStart` 必須嚴格基於回呼傳入的 `scheduledTime`。
    4. **預防機制**：未來新增發聲積木時，若該積木可能出現在迴圈中，生成器必須顯式傳遞 `scheduledTime` 變數。

- **動態選單與 XML 載入順序**：
  - **現象**：載入 XML 時提示 `unavailable option: MyInstrument`。
  - **成因**：當積木試圖恢復一個尚未在工作區中被「建立」的樂器名稱時，Blockly 的驗證機制會攔截該值。
  - **解法**：在 `FieldDropdown` 的選項函式中，手動將 `this.getValue()` 的目前值暫時加入 `options` 列表，以通過載入期的合法性檢查。

## 今日追加進度
1. **非同步編曲架構升級**：
   - 強制覆寫 Blockly 函式產生器，使其自動支援 `async function` 定義與 `await` 呼叫。
   - 修改 `buttons.js`，使用 `AsyncFunction` 容器執行積木程式碼，解決長篇編曲時的 `SyntaxError`。
2. **範例庫全面升級 (01-14)**：
   - 新增 **範例 10**：函式模組化編曲。
   - 新增 **範例 10-2**：精確排程 (Scheduling) 編曲。
   - 新增 **範例 10-3**：音序器線性接龍技巧。
   - 完成 11-14 硬體範例的帽子積木化改造與加註。
3. **UI/UX 穩定性增強**：
   - 為帽子積木註冊機制引入 **150ms 防抖 (Debounce)**，消除範例載入時的大量冗餘日誌。

## 關鍵技術細節 (追加)
- **Async 產生器衝突**：Blockly 的標準函式產生器在某些環境下會覆蓋自訂覆寫，必須在 `getBlocksCode` 呼叫前一刻再次強制執行覆寫。
- **16 格對位邏輯**：在函式中，音序器的「小節 [N]」是相對於目前執行時間 `t1` 的偏移量，而非整首歌的絕對位置。

