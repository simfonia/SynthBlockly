# 2025-12-30 工作日誌 (SynthBlockly)

## 本次完成任務
- **日誌系統全面分層化**:
    - 實作「錯誤/警告」(上方) 與「一般訊息」(下方) 的雙區塊顯示邏輯。
    - **Logger 核心更新**: 
        - 支援 `warning` 類型。
        - 根據類型自動分流至 `#error-log` 或 `#log` 元素。
        - 獨立設定上限：一般訊息 100 行，錯誤/警告 50 行。
    - **UI 樣式優化**:
        - 為所有日誌類型實作「條紋底色 (Striping)」，包括錯誤與警告。
        - 新增 `.log-warning` 專屬樣式（黃底黑字）。
    - **全域調用檢查**: 修正全專案 180+ 處 `log()` 呼叫，確保錯誤與警告訊息能正確出現在上方區塊。

- **效果器系統 Bug 修復與優化**:
    - **參數解析修正**: 解決了負數參數（如 `-40dB`）在 Blockly 產生的程式碼中因帶有括號 `(-40)` 導致 `parseFloat` 解析失敗（變為 `NaN`）的問題。這修復了 Limiter 無效的狀況。
    - **濾波器邏輯修正**: 修正了 `filter` 效果器在產生器中類別傳遞錯誤的問題，現在能正確辨識 lowpass/highpass 等模式。
    - **效果鏈順序校正**: 現在效果器會依照視覺上的積木順序（由上而下）建立連線。
    - **重複連線排除**: 使用 `Set` 處理樂器清單，解決了 `DefaultSynth` 被重複連接到效果鏈導致音量異常的問題。

- **極速停止機制 (Instant Panic Stop)**:
    - **斷連機制**: 按下停止時，立即呼叫 `instr.disconnect()` 切斷所有樂器與喇叭的連線，強制終止已排程的殘餘音符。
    - **執行旗標**: 引入 `audioEngine.isExecutionActive` 旗標。
    - **積木攔截**: 更新 `wait`、`loop` 及所有 `play` 相關積木產生器，在執行前檢查旗標，若系統已停止則立即中斷非同步邏輯。
    - **時鐘重設**: 加入 `Tone.Transport.cancel(0)` 與 `seconds = 0`，確保所有音軌立即清空並重頭開始。

- **開發體驗與清理**:
    - 清除了多餘的 `console.log` 與冗餘的 UI log 輸出。
    - 修復了「測試音符」按鈕在重置後指向舊樂器實例的 Bug。

## 異動檔案
- `SynthBlockly/js/ui/logger.js`
- `SynthBlockly/styles.css`
- `SynthBlockly/js/core/audioEngine.js`
- `SynthBlockly/js/core/midiEngine.js`
- `SynthBlockly/js/core/serialEngine.js`
- `SynthBlockly/js/core/blocklyManager.js`
- `SynthBlockly/js/ui/keyboardController.js`
- `SynthBlockly/js/ui/buttons.js`
- `SynthBlockly/js/blocks/instruments_generators.js`
- `SynthBlockly/js/blocks/effects_generators.js`
- `SynthBlockly/js/blocks/transport_generators.js`
- `SynthBlockly/js/blocks/sampler_generators.js`