# SynthBlockly 工作日誌

## 2025年12月28日

### 本次工作重點與重要異動

本次工作主要集中於 `SynthBlockly` 專案的音訊取樣器功能開發與問題修正。

1.  **實現「自訂取樣器」積木**
    *   新增 `sb_create_custom_sampler` 積木，允許使用者上傳自訂 WAV 檔案建立樂器。
    *   為此創建了 `js/blocks/sampler_blocks.js` (積木定義) 和 `js/blocks/sampler_generators.js` (程式碼產生器)。
    *   修改 `js/core/audioEngine.js`，新增 `createCustomSampler` 函數，用於實例化 `Tone.Sampler`。
    *   更新 `js/blocks/instruments_generators.js`，使 `sb_set_adsr` 積木能正確設定自訂取樣器的 ADSR 參數。
    *   在 `js/blocks/lang/en.js` 和 `js/blocks/lang/zh-hant.js` 中新增了翻譯字串。
    *   更新 `js/blocks/index.js` 以註冊新的積木和產生器。
    *   更新 `SynthBlockly/FILE_STRUCTURE.md` 以反映檔案結構變更。

2.  **取樣器積木重構與預設音色整合**
    *   將 `sb_create_custom_sampler` 重命名為更通用的 `sb_create_sampler_instrument`。
    *   在積木中加入了下拉選單，提供「預設鋼琴」、「小提琴撥奏」、「小提琴持續音」和「自訂」等選項。
    *   從 `js/blocks/instruments_blocks.js` 中的 `sb_create_synth_instrument` 積木移除了「Sampler」選項。
    *   更新 `js/core/toolbox.js` 以反映新的積木類型。
    *   更新語系檔以包含新選項的翻譯。

3.  **解決 `sampler.loaded.then is not a function` 錯誤**
    *   修正 `js/core/audioEngine.js` 中 `createCustomSampler` 的 `Tone.Sampler` 實例化，將 Promise-based 的 `sampler.loaded.then()` 改為使用 `onload` 回呼函數，以符合專案當前的 `Tone.js` 版本 API。

4.  **修正「設定樂器音量」積木錯誤 (`TypeError: Cannot read properties of undefined (reading 'rampTo')`)**
    *   修改 `js/blocks/instruments_generators.js`，使 `sb_set_instrument_volume` 產生器能正確區分 `CustomSampler` (自訂取樣器) 和其他樂器類型，並對 `CustomSampler` 的音量進行正確控制。

5.  **修正小提琴樣本的音準與音量問題**
    *   **音準修正**：根據使用者回饋，修正了小提琴樣本檔名的八度標示錯誤（例如 `F4.wav` 實際上為 `F#4` 後來改為 `Gb4`，以及整體音高上移一個八度）。為此：
        *   將 `public/samples/violin/` 目錄下所有小提琴樣本檔案的檔名進行了重新命名，以正確反映其真實音高。
        *   更新了 `js/blocks/sampler_generators.js` 中的 `violinSampleMap`，使其對應到修正後的檔名。
    *   **音量增益**：應使用者要求，在 `js/core/audioEngine.js` 的 `createCustomSampler` 函數中，將 `Tone.Sampler` 的預設音量從 6dB 設定為 6dB（先前嘗試增至 10dB 後又應要求還原）。
    *   為確保說明文件同步，將支援的音訊格式資訊添加到 `public/docs/custom_sampler_en.html` 和 `public/docs/custom_sampler_zh-hant.html`。

6.  **持續音堆疊 / 音符偷取問題 (多次嘗試)**
    *   最初嘗試透過 `Tone.Sampler` 的內部包絡管理，並在 `triggerAttack` 時呼叫 `sampler.triggerRelease` 來解決堆疊問題，但未完全成功。
    *   為了解決音符快速切換時前一個音符被直接切斷（不自然釋放）以及音符堆疊的問題，實作了**基於 `Tone.Gain` 節點的語音管理系統**於 `js/core/audioEngine.js` 的 `createCustomSampler` 函數中。
        *   該系統為每個音符創建並管理獨立的 `Tone.Gain` 節點，實現了基於 ADSR 參數的平滑起音、衰減、延音和釋放曲線。
        *   實施了「語音搶占」機制，確保當同一個音符再次被觸發時，前一個音符的 `Gain` 節點會被停止並釋放，從而防止音符堆疊。
        *   更新 `instrumentWrapper` 的 `triggerAttack`、`triggerRelease`、`triggerAttackRelease`、`set`、`chain` 和 `dispose` 方法，使其與新的 `Tone.Gain` 節點管理系統互動。
        *   更新 `resetAudioEngineState` 以確保在緊急停止時能正確釋放所有活躍的 `Gain` 節點。
    *   **後續問題**：使用者回報此複雜的 `Tone.Gain` 解決方案仍導致堆疊。這表明需要進一步偵錯並尋找根本原因。

7.  **解決 `ReferenceError: envelopeSettings is not defined` 錯誤**
    *   修正 `js/blocks/sampler_generators.js` 中的程式碼產生邏輯，將包絡設定物件文字直接嵌入到 `createCustomSampler` 函數的呼叫中，而不是透過變數，解決了在執行產生程式碼時發生的引用錯誤。

### 檔案結構異動

-   `SynthBlockly/js/blocks/sampler_blocks.js`: **新增**取樣器積木定義。
-   `SynthBlockly/js/blocks/sampler_generators.js`: **新增**取樣器積木的程式碼產生邏輯，並進行多次修正。
-   `SynthBlockly/js/blocks/instruments_blocks.js`: **修改**，移除 `sb_create_synth_instrument` 中的「Sampler」選項。
-   `SynthBlockly/js/blocks/instruments_generators.js`: **修改**，更新 `sb_set_adsr` 和 `sb_set_instrument_volume` 以處理自訂取樣器。
-   `SynthBlockly/js/blocks/lang/en.js`: **修改**，新增/更新取樣器相關的翻譯字串。
-   `SynthBlockly/js/blocks/lang/zh-hant.js`: **修改**，新增/更新取樣器相關的翻譯字串。
-   `SynthBlockly/js/blocks/index.js`: **修改**，註冊新的取樣器積木和產生器。
-   `SynthBlockly/js/core/audioEngine.js`: **核心修改**，新增 `createCustomSampler` 函數，並進行多次重構以處理取樣器載入、ADSR、音量、堆疊問題 (多次嘗試)。
-   `SynthBlockly/js/core/toolbox.js`: **修改**，將新的取樣器積木添加到工具箱。
-   `SynthBlockly/public/docs/custom_sampler_en.html`: **新增**自訂取樣器英文說明文件。
-   `SynthBlockly/public/docs/custom_sampler_zh-hant.html`: **新增**自訂取樣器正體中文說明文件。
-   `SynthBlockly/public/samples/violin/violin-section-pizzicato/`: **修改**，重新命名並清理 `.wav` 樣本檔案。
-   `SynthBlockly/public/samples/violin/violin-section-vibrato-sustain/`: **修改**，重新命名並清理 `.wav` 樣本檔案。