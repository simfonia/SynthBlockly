## 2026-01-27 任務紀錄：廣播系統實作與多軌並行優化

### 1. 廣播系統 (Broadcast System)
- **核心實作**：在 `audioEngine.js` 中新增了基於訊息名稱的發送與監聽機制 (`broadcast`, `registerMessageListener`)。
- **全新積木**：在「工具 (Tools)」分類中新增了「廣播訊息」與「當收到訊息」(帽子積木)。
- **異步調度**：廣播發送端採用非阻塞設計，確保主程式能立刻繼續執行，而多個接收端能同時啟動。

### 2. 多軌並行演奏優化
- **定向演奏積木**：為 `sb_play_melody` (演奏旋律清單) 新增了「目標樂器」下拉選單。
- **解決競爭問題**：`SequencerService.js` 現在支援強制作業於特定樂器實例，避免了並行時對「當前音源」全域狀態的爭奪。
- **視覺化同步**：定向播放現在也會同步觸發 ADSR 視覺化動畫。

### 3. 系統加固與 Bug 修復
- **載入等待機制**：強化了 `waitForSamples`，會逐一檢查所有 `Sampler` 的載入狀態，確保音色就緒後才發出執行訊號。
- **自動註冊機制**：在 `buttons.js` 執行流程中加入了強制 Hats 同步與 HatBlockManager 重設，解決了「發送廣播時接收者未就位」的問題。
- **Polyfills**：實作了 Blockly v12 變數 API 的 Polyfill，消除了控制台的所有棄用警告。
- **BPM 積木修復**：修正了 `sb_transport_set_bpm` 產生器讀取欄位名稱錯誤的問題。

### 4. 程式碼重構
- **建立 `blocklyUtils.js`**：提取了 `FieldDropdownLenient` 和 `getInstrumentOptions` 等共用工具，優化模組相依性。
- **清理重複代碼**：移除了 `melody_blocks.js` 中過時的樂器選擇邏輯，統一由 `instruments_blocks.js` 處理。

### 5. 教材範例
- **新增 15-1 (廣播多軌並行)**：展示如何用廣播製作小提琴與鋼琴的對位重奏。
- **新增 15-2 (時序排程多軌)**：展示如何利用 Transport Loop 對齊多條旋律。
- **修復 12 (Wah-wah)**：改用新開發的「設定效果參數」執行型積木，實現 Arduino 即時控制。

## 2026-01-27 工作記錄 (下午)
### 完成項目：
1. **跨軌道同步 (Example 11-2)**:
   - 升級 SequencerService 支援「瞬間預約」模式（偵測到 startTime 時跳過 wait）。
   - 修改 	ransport_generators.js 移除 sb_tone_loop 內部的 wait 注入，達成並行排程。
   - 修正了 11-2 鋼琴晚一輪 Loop 的問題。
2. **防重疊機制**:
   - 實作「UI 鎖定 + 非同步強力清場」方案。
   - panicStopAllSounds 改為 sync 並內建 300ms 延遲以穩定音訊執行緒。
3. **架構固化**:
   - 移除 generationID 等臨時調試邏輯，回歸精簡架構。
   - 移除樂器容器銜接點，防止產碼順序 Bug。
4. **範例優化**:
   - 更新 11-2 範例為教學等級的「線性 vs 排程」對比示範。
